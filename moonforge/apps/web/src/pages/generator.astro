---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Generate Art | Moonbirds Art Forge" description="Create your own Wizard-Moonbird-style artwork using AI">
  <section class="py-12 px-4 md:py-20">
    <div class="container mx-auto max-w-6xl">
      <h1 class="text-4xl md:text-5xl font-bold mb-6 text-center bg-gradient-to-r from-primary to-primary-light bg-clip-text text-transparent">
        Create Your Moonbird Art
      </h1>
      <p class="text-xl text-center mb-12 text-foreground/80 max-w-2xl mx-auto">
        Describe your vision and our AI will generate a unique Moonbird-style artwork that you can mint as an NFT.
      </p>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
        <!-- Image Preview Area -->
        <div class="bg-background-light/10 rounded-xl border border-background-light/20 p-6 flex flex-col items-center justify-center min-h-[400px]" id="image-preview-container">
          <div id="image-preview" class="w-full h-full flex items-center justify-center">
            <div class="text-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mx-auto text-foreground/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <p class="mt-4 text-foreground/60">Your generated image will appear here</p>
            </div>
          </div>
          <div class="loading-indicator hidden w-full h-full flex items-center justify-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary"></div>
            <p class="ml-4 text-foreground/80">Generating your masterpiece...</p>
          </div>
        </div>

        <!-- Generation Controls -->
        <div class="bg-background-light/10 rounded-xl border border-background-light/20 p-6">
          <form id="generation-form" 
                hx-post="/api/generate" 
                hx-target="#image-preview" 
                hx-swap="innerHTML" 
                hx-indicator=".loading-indicator"
                hx-on="htmx:beforeRequest: showLoading()"
                hx-on="htmx:afterRequest: hideLoading()"
                hx-on="htmx:sendError: handleError(event)"
          >
            <div class="mb-6">
              <label for="prompt" class="block text-sm font-medium text-foreground/80 mb-2">Describe your vision</label>
              <textarea
                id="prompt"
                name="prompt"
                rows="4"
                class="w-full px-4 py-3 bg-background-dark border border-background-light/20 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none"
                placeholder="A wizard moonbird with a glowing staff, cosmic background, mystical energy, detailed feathers..."
                required
              ></textarea>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-medium text-foreground/80 mb-4">Style Influence</label>
              <div class="grid grid-cols-3 gap-4">
                <button type="button" class="style-preset p-3 border border-background-light/20 rounded-lg hover:bg-background-light/20 transition" data-style="wizard">
                  <span class="block text-center text-xs mb-1">Wizard</span>
                  <div class="h-16 bg-background-light/30 rounded flex items-center justify-center">
                    <span class="text-2xl">ðŸ§™</span>
                  </div>
                </button>
                <button type="button" class="style-preset p-3 border border-background-light/20 rounded-lg hover:bg-background-light/20 transition" data-style="cosmic">
                  <span class="block text-center text-xs mb-1">Cosmic</span>
                  <div class="h-16 bg-background-light/30 rounded flex items-center justify-center">
                    <span class="text-2xl">âœ¨</span>
                  </div>
                </button>
                <button type="button" class="style-preset p-3 border border-background-light/20 rounded-lg hover:bg-background-light/20 transition" data-style="cyber">
                  <span class="block text-center text-xs mb-1">Cyber</span>
                  <div class="h-16 bg-background-light/30 rounded flex items-center justify-center">
                    <span class="text-2xl">ðŸ¤–</span>
                  </div>
                </button>
              </div>
              <input type="hidden" id="style" name="style" value="wizard">
            </div>

            <div class="mb-6">
              <label for="creativity" class="block text-sm font-medium text-foreground/80 mb-2">Creativity Level</label>
              <div class="flex items-center">
                <span class="text-xs text-foreground/60 mr-2">Precise</span>
                <input
                  id="creativity"
                  name="creativity"
                  type="range"
                  min="0"
                  max="100"
                  value="70"
                  class="w-full h-2 bg-background-light/20 rounded-lg appearance-none cursor-pointer accent-primary"
                />
                <span class="text-xs text-foreground/60 ml-2">Creative</span>
              </div>
              <div class="text-xs text-center mt-1 text-foreground/60" id="creativity-value">70%</div>
            </div>

            <div class="mb-6">
              <label for="size" class="block text-sm font-medium text-foreground/80 mb-2">Image Size</label>
              <select
                id="size"
                name="size"
                class="w-full px-4 py-2 bg-background-dark border border-background-light/20 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              >
                <option value="512x512">512 Ã— 512 (Standard)</option>
                <option value="768x768">768 Ã— 768 (Large)</option>
                <option value="1024x1024">1024 Ã— 1024 (Extra Large)</option>
              </select>
            </div>

            <div class="flex justify-between items-center">
              <button
                type="button"
                id="random-prompt"
                class="px-4 py-2 bg-background-light/20 rounded-lg hover:bg-background-light/30 transition"
              >
                Random Idea
              </button>
              <button
                type="submit"
                class="px-6 py-3 bg-primary hover:bg-primary-light text-background font-medium rounded-lg transition flex items-center"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                </svg>
                Generate
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- NFT Minting Section -->
      <div class="mt-12 bg-background-light/10 rounded-xl border border-background-light/20 p-6 text-center hidden" id="mint-section">
        <h2 class="text-2xl font-bold mb-4">Love Your Creation?</h2>
        <p class="mb-6 text-foreground/80 max-w-2xl mx-auto">
          Mint your artwork as an NFT on the Base L2 network and share it with the world.
        </p>
        <div class="flex justify-center space-x-4">
          <button
            id="mint-button"
            class="px-6 py-3 bg-accent hover:bg-accent-light text-background font-medium rounded-lg transition flex items-center"
            disabled
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" />
              <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd" />
            </svg>
            Connect Wallet to Mint
          </button>
          <button
            id="share-button"
            class="px-6 py-3 bg-background-light/20 hover:bg-background-light/30 text-foreground font-medium rounded-lg transition flex items-center"
            disabled
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
            </svg>
            Share
          </button>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script>
  function showLoading() {
    document.querySelector('.loading-indicator').classList.remove('hidden');
    document.querySelector('#image-preview').classList.add('hidden');
  }
  
  function hideLoading() {
    document.querySelector('.loading-indicator').classList.add('hidden');
    document.querySelector('#image-preview').classList.remove('hidden');
  }
  
  function handleError(event) {
    console.error('Generation error:', event.detail);
    hideLoading();
    document.querySelector('#image-preview').innerHTML = `
      <div class="text-center p-4">
        <div class="text-red-500 mb-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <p class="text-lg font-medium">Connection failed</p>
        <p class="text-sm text-foreground/60 mt-1">Please check your network and try again</p>
      </div>
    `;
  }
  
  function resetGenerator() {
    document.querySelector('#generation-form').reset();
    document.querySelector('#image-preview').innerHTML = `
      <div class="text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mx-auto text-foreground/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <p class="mt-4 text-foreground/60">Your generated image will appear here</p>
      </div>
    `;
  }
  
  // Initialize HTMX when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    htmx.config.defaultSwapStyle = 'innerHTML';
  });
</script>

<script>
  // HTMX is loaded via CDN in the BaseLayout
  document.addEventListener('astro:page-load', () => {
    // Style preset buttons
    const stylePresets = document.querySelectorAll('.style-preset');
    const styleInput = document.getElementById('style') as HTMLInputElement | null;

    if (stylePresets.length > 0 && styleInput) {
      stylePresets.forEach(button => {
        button.addEventListener('click', () => {
          // Remove active class from all buttons
          stylePresets.forEach(btn => btn.classList.remove('ring-2', 'ring-primary'));
          
          // Add active class to clicked button
          button.classList.add('ring-2', 'ring-primary');
          
          // Update hidden input
          const style = (button as HTMLElement).dataset.style;
          if (style) {
            styleInput.value = style;
          }
        });
      });

      // Set initial active style
      stylePresets[0].classList.add('ring-2', 'ring-primary');
    }

    // Creativity slider
    const creativitySlider = document.getElementById('creativity') as HTMLInputElement | null;
    const creativityValue = document.getElementById('creativity-value');

    if (creativitySlider && creativityValue) {
      creativitySlider.addEventListener('input', () => {
        creativityValue.textContent = `${creativitySlider.value}%`;
      });
    }

    // Random prompt generator
    const randomPromptButton = document.getElementById('random-prompt');
    const promptInput = document.getElementById('prompt') as HTMLTextAreaElement | null;

    const randomPrompts = [
      "A wizard moonbird casting a spell with glowing cyan energy, cosmic background",
      "A moonbird with a wizard hat and staff, surrounded by magical runes and potions",
      "A cyberpunk moonbird with neon lights and technological augmentations",
      "A moonbird in space, with stars and nebulae reflecting in its eyes",
      "A moonbird as an ancient sage, with flowing robes and a long beard",
      "A moonbird alchemist mixing potions in a medieval laboratory",
      "A moonbird time traveler with steampunk goggles and a pocket watch",
      "A moonbird explorer in a lush alien jungle with bioluminescent plants"
    ];

    if (randomPromptButton && promptInput) {
      randomPromptButton.addEventListener('click', () => {
        const randomIndex = Math.floor(Math.random() * randomPrompts.length);
        promptInput.value = randomPrompts[randomIndex];
      });
    }

    // Form submission handling
    const generationForm = document.getElementById('generation-form');
    const imagePreview = document.getElementById('image-preview');
    const imageLoading = document.getElementById('image-loading');
    const mintSection = document.getElementById('mint-section');

    if (generationForm && imagePreview && imageLoading && mintSection) {
      generationForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        // Show loading state
        imagePreview.classList.add('hidden');
        imageLoading.classList.remove('hidden');
        
        // Simulate API call (will be replaced with actual API)
        setTimeout(() => {
          // Hide loading state
          imagePreview.classList.remove('hidden');
          imageLoading.classList.add('hidden');
          
          // Display a placeholder image (will be replaced with actual API response)
          imagePreview.innerHTML = `
            <img src="https://placehold.co/512x512/3a3a3c/FFFFFF/png?text=Moonbird+Art" alt="Generated Moonbird Art" class="rounded-lg shadow-lg max-w-full max-h-[400px]">
          `;
          
          // Show mint section
          mintSection.classList.remove('hidden');
        }, 3000);
      });
    }
  });
</script>
